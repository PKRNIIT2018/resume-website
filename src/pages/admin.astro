---
import BaseLayout from '../layouts/BaseLayout.astro';
import { resumeData } from '../data/resumeData';

// Check if user is authenticated
const isAuthenticated = Astro.cookies.get('admin_auth')?.value === 'true';
let loginError = '';

const totalSkillsCount = resumeData.skills.flatMap((s: { items: string[] }) => s.items).length;

// Handle logout
if (Astro.url.searchParams.get('logout') === 'true') {
  Astro.cookies.delete('admin_auth', { path: '/' });
  return Astro.redirect('/admin');
}

// If not authenticated, show login form
if (!isAuthenticated) {
  // Handle login POST request
  if (Astro.request.method === 'POST') {
    try {
      const formData = await Astro.request.formData();
      const password = formData.get('password');
      const adminPassword = import.meta.env.ADMIN_PASSWORD;
      
      if (!adminPassword) {
        loginError = 'Admin password not configured in environment.';
      } else if (password === adminPassword) {
        Astro.cookies.set('admin_auth', 'true', {
          path: '/',
          maxAge: 60 * 60 * 24, // 24 hours
          httpOnly: true,
          secure: import.meta.env.PROD,
          sameSite: 'strict'
        });
        return Astro.redirect('/admin');
      } else {
        loginError = 'Invalid password. Please try again.';
      }
    } catch (error) {
      console.error('Login error:', error);
      loginError = 'An error occurred during login. Please try again.';
    }
  }
}
---

{!isAuthenticated ? (
  <BaseLayout title="Admin Login - Prasanth Kunnumal Ramesh">
    <main class="login-container">
      <div class="login-box">
        <h1>Admin Login</h1>
        <p class="login-description">Enter your password to access the admin panel</p>
        {loginError && (
          <div class="error-message">
            {loginError}
          </div>
        )}
        <form method="POST" class="login-form">
          <div class="form-group">
            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              autofocus
              placeholder="Enter admin password"
            />
          </div>
          <button type="submit" class="btn btn-primary">Login</button>
        </form>
      </div>
    </main>
  </BaseLayout>
) : (
  <BaseLayout title="Admin Panel - Resume & Cover Letter Generator">
    <main class="admin-container">
      <div class="admin-header">
        <h1>Resume & Cover Letter Generator</h1>
        <a href="/admin?logout=true" class="btn btn-secondary">Logout</a>
      </div>

      <div class="admin-content">
        <div class="instructions">
          <h2>Instructions</h2>
          <p>Paste a job description URL or enter the job description text below. The system will generate a customized resume and a high-impact cover letter (now using an <strong>Expert Executive Career Coach</strong> persona) tailored to the role.</p>
        </div>

        <form id="generatorForm" class="generator-form">
          <div class="form-group">
            <label for="jobUrl">Job Description URL (Optional)</label>
            <input 
              type="url" 
              id="jobUrl" 
              name="jobUrl" 
              placeholder="https://example.com/job-posting"
            />
            <small>Or paste the job description text below</small>
          </div>

          <div class="form-group">
            <label for="jobDescription">Job Description</label>
            <textarea 
              id="jobDescription" 
              name="jobDescription" 
              rows="15"
              placeholder="Paste the complete job description here..."
              required
            ></textarea>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="generateBtn">
              <span class="btn-text">Generate Resume & Cover Letter</span>
              <span class="btn-loader" style="display: none;">Generating...</span>
            </button>
          </div>
        </form>
        
        <!-- LinkedIn Skill Optimizer Section -->
        <div class="document-section linkedin-optimizer">
          <div class="document-header">
            <h3>LinkedIn Profile Optimizer (2026 Edition)</h3>
            <button class="btn btn-secondary" id="copyAllSkillsBtn">Copy All Skills</button>
          </div>
          <div class="instructions" style="margin-bottom: var(--space-4); border-left-color: var(--accent);">
            <p>Paste these into your LinkedIn profile to maximize recruiter hits. Individual buttons copy the name, "Copy All" gives you a comma-separated list.</p>
          </div>
          <div id="linkedinSkillsList" class="skills-grid admin-skills-grid">
            <!-- Skills will be injected here -->
          </div>
        </div>

        <div id="results" class="results" style="display: none;">
          <h2>Generated Documents</h2>
          
          <!-- Gap Analysis Section -->
          <div class="document-section gap-analysis">
            <div class="document-header" style="border-bottom-color: #ef4444;">
              <h3 style="color: #ef4444;">Recruiter Risk Assessment (Gap Analysis)</h3>
            </div>
            <div id="gapAnalysisContent" class="document-content" style="background: #fef2f2; border: 1px solid #fee2e2;"></div>
          </div>
          
          <div class="document-section">
            <div class="document-header">
              <h3>Resume</h3>
              <button class="btn btn-secondary" onclick="downloadResume()">Download Resume (PDF)</button>
            </div>
            <div id="resumeContent" class="document-content"></div>
          </div>

          <div class="document-section">
            <div class="document-header">
              <h3>Cover Letter</h3>
              <button class="btn btn-secondary" onclick="downloadCoverLetter()">Download PDF</button>
              <button class="btn btn-secondary" onclick="downloadCoverLetterDocx()" style="margin-left: 10px;">Download Word</button>
            </div>
            <div id="coverLetterContent" class="document-content"></div>
          </div>
        </div>
      </div>
    </main>

    <script>
      import jsPDF from 'jspdf';
      import { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType } from 'docx';
      import { saveAs } from 'file-saver';
      import { resumeData } from '../data/resumeData';

      // --- LinkedIn Skill Optimizer Logic ---
      const linkedinSkillsList = document.getElementById('linkedinSkillsList');
      const copyAllSkillsBtn = document.getElementById('copyAllSkillsBtn');

      const metaSkills = [
        "Strategic Planning", 
        "Cross-functional Team Leadership", 
        "Software Development Life Cycle (SDLC)",
        "Enterprise Architecture",
        "Digital Transformation",
        "IT Strategy",
        "Agentic AI Workflows (AntiGravity)",
        "Local LLM Privacy Strategy (Ollama)"
      ];

      const allSkills = [...new Set([
        ...resumeData.skills.flatMap(category => category.items),
        ...metaSkills
      ])].sort();

      function renderLinkedInSkills() {
        if (!linkedinSkillsList) return;
        
        linkedinSkillsList.innerHTML = allSkills.map(skill => `
          <div class="skill-item">
            <span class="skill-name">${skill}</span>
            <button class="copy-skill-btn" title="Copy ${skill}">
              <span class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
              </span>
              <span class="copy-success" style="display: none; color: #10b981; font-weight: bold; font-size: 10px;">COPIED!</span>
            </button>
          </div>
        `).join('');

        // Add event listeners to individual copy buttons
        document.querySelectorAll('.skill-item').forEach(item => {
          const btn = item.querySelector('.copy-skill-btn');
          const skillName = item.querySelector('.skill-name')?.textContent;
          const icon = btn?.querySelector('.copy-icon') as HTMLElement;
          const success = btn?.querySelector('.copy-success') as HTMLElement;

          btn?.addEventListener('click', () => {
            if (skillName) {
              navigator.clipboard.writeText(skillName).then(() => {
                console.log(`[Admin] Copied skill: "${skillName}"`);
                if (icon) icon.style.display = 'none';
                if (success) success.style.display = 'inline';
                
                setTimeout(() => {
                  if (icon) icon.style.display = 'inline';
                  if (success) success.style.display = 'none';
                }, 1500);
              });
            }
          });
        });
      }

      copyAllSkillsBtn?.addEventListener('click', () => {
        const textToCopy = allSkills.join(', ');
        navigator.clipboard.writeText(textToCopy).then(() => {
          console.log(`[Admin] Copied all skills (${allSkills.length} total)`);
          const btn = copyAllSkillsBtn as HTMLButtonElement | null;
          if (btn) {
            const originalText = btn.textContent;
            btn.textContent = 'Copied All!';
            btn.classList.add('btn-success');
            
            setTimeout(() => {
              btn.textContent = originalText;
              btn.classList.remove('btn-success');
            }, 2000);
          }
        });
      });

      renderLinkedInSkills();

      // --- Resume & Cover Letter Generator Logic ---

      const form = document.getElementById('generatorForm') as HTMLFormElement | null;
      const generateBtn = document.getElementById('generateBtn') as HTMLButtonElement | null;
      const btnText = generateBtn?.querySelector('.btn-text') as HTMLElement | null;
      const btnLoader = generateBtn?.querySelector('.btn-loader') as HTMLElement | null;
      const results = document.getElementById('results') as HTMLElement | null;
      const resumeContent = document.getElementById('resumeContent') as HTMLElement | null;
      const coverLetterContent = document.getElementById('coverLetterContent') as HTMLElement | null;
      const gapAnalysisContent = document.getElementById('gapAnalysisContent') as HTMLElement | null;

      let generatedResume = '';
      let generatedCoverLetter = '';
      let generatedGapAnalysis = '';

      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const jobUrl = (document.getElementById('jobUrl') as HTMLInputElement | null)?.value || '';
        const jobDescription = (document.getElementById('jobDescription') as HTMLTextAreaElement | null)?.value || '';

        if (!jobDescription.trim()) {
          alert('Please enter a job description');
          return;
        }

        // Show loading state
        if (generateBtn) generateBtn.disabled = true;
        if (btnText) btnText.style.display = 'none';
        if (btnLoader) btnLoader.style.display = 'inline';
        if (results) results.style.display = 'none';

        try {
          const response = await fetch('/api/generate-documents', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              jobUrl,
              jobDescription
            })
          });

          if (!response.ok) {
            throw new Error('Failed to generate documents');
          }

          const data = await response.json();

          // Store generated content
          generatedResume = data.resume;
          generatedCoverLetter = data.coverLetter;
          generatedGapAnalysis = data.gapAnalysis;

          // Display results
          if (resumeContent) resumeContent.innerHTML = `<pre>${escapeHtml(data.resume)}</pre>`;
          if (coverLetterContent) coverLetterContent.innerHTML = `<pre>${escapeHtml(data.coverLetter)}</pre>`;
          if (gapAnalysisContent) gapAnalysisContent.innerHTML = `<div class="gap-list">${formatGapAnalysis(data.gapAnalysis)}</div>`;
          if (results) results.style.display = 'block';

          // Scroll to results
          results?.scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
          console.error('Error:', error);
          alert('Failed to generate documents. Please try again.');
        } finally {
          // Reset button state
          if (generateBtn) generateBtn.disabled = false;
          if (btnText) btnText.style.display = 'inline';
          if (btnLoader) btnLoader.style.display = 'none';
        }
      });

      function escapeHtml(text: string) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function formatGapAnalysis(text: string) {
        if (!text) return 'Analysis unavailable.';
        
        // Convert the bulleted list into pretty HTML
        const lines = text.split('\n');
        let html = '<ul>';
        
        lines.forEach(line => {
          const trimmed = line.trim();
          if (trimmed.startsWith('-') || trimmed.startsWith('*') || /^\d+\./.test(trimmed)) {
            const content = trimmed.replace(/^[-*]|\d+\.\s*/, '').trim();
            if (content) html += `<li>${content}</li>`;
          } else if (trimmed) {
            html += `<p>${trimmed}</p>`;
          }
        });
        
        html += '</ul>';
        return html;
      }

      (window as any).downloadResume = function() {
        generatePDF(generatedResume, 'Prasanth_K_Ramesh_Resume.pdf');
      };

      (window as any).downloadCoverLetter = function() {
        generatePDF(generatedCoverLetter, 'Prasanth_K_Ramesh_Cover_Letter.pdf');
      };

      (window as any).downloadCoverLetterDocx = function() {
        generateDocx(generatedCoverLetter, 'Prasanth_K_Ramesh_Cover_Letter.docx');
      };

      async function generateDocx(content: string, filename: string) {
        if (!content) return;

        const lines = content.split('\n');
        const children = [];

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          
          if (!line) {
             children.push(new Paragraph({ text: "" })); // Empty line
             continue;
          }

          let paragraph;

          if (line.startsWith('# ')) {
            paragraph = new Paragraph({
              text: line.substring(2),
              heading: HeadingLevel.HEADING_1,
              spacing: { after: 200 }
            });
          } else if (line.startsWith('## ')) {
             paragraph = new Paragraph({
              text: line.substring(3),
              heading: HeadingLevel.HEADING_2,
              spacing: { after: 150, before: 150 }
            });
          } else if (line.startsWith('### ')) {
             paragraph = new Paragraph({
              text: line.substring(4),
              heading: HeadingLevel.HEADING_3,
              spacing: { after: 120, before: 120 }
            });
          } else if (line.startsWith('- ') || line.startsWith('* ')) {
             paragraph = new Paragraph({
              text: line.substring(2),
              bullet: { level: 0 }
            });
          } else {
            // Handle bold text (**text**)
            const parts = line.split(/(\*\*.*?\*\*)/g);
            const textRuns = parts.map(part => {
              if (part.startsWith('**') && part.endsWith('**')) {
                return new TextRun({
                  text: part.substring(2, part.length - 2),
                  bold: true
                });
              }
              return new TextRun(part);
            });

            paragraph = new Paragraph({
              children: textRuns,
              spacing: { after: 120 }
            });
          }
          children.push(paragraph);
        }

        const doc = new Document({
          sections: [{
            properties: {},
            children: children
          }]
        });

        const blob = await Packer.toBlob(doc);
        saveAs(blob, filename);
      }

      function generatePDF(content: string, filename: string) {
        const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        // Set font
        doc.setFont('helvetica');
        
        // Page dimensions
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 20;
        const maxWidth = pageWidth - (margin * 2);
        
        // Split content into lines
        const lines = content.split('\n');
        let y = margin;
        
        lines.forEach((line) => {
          // Check if we need a new page
          if (y > pageHeight - margin) {
            doc.addPage();
            y = margin;
          }
          
          // Handle different text styles based on markdown-like patterns
          if (line.startsWith('# ')) {
            // Main heading
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            const text = line.substring(2);
            doc.text(text, margin, y);
            y += 10;
          } else if (line.startsWith('## ')) {
            // Section heading
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            const text = line.substring(3);
            doc.text(text, margin, y);
            y += 8;
          } else if (line.startsWith('### ')) {
            // Subsection heading
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            const text = line.substring(4);
            doc.text(text, margin, y);
            y += 7;
          } else if (line.startsWith('**') && line.endsWith('**')) {
            // Bold text
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            const text = line.replace(/\*\*/g, '');
            doc.text(text, margin, y);
            y += 6;
          } else if (line.startsWith('- ') || line.startsWith('* ')) {
            // Bullet points
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const text = line.substring(2);
            const wrappedText = doc.splitTextToSize(text, maxWidth - 5);
            doc.text('•', margin, y);
            doc.text(wrappedText, margin + 5, y);
            y += wrappedText.length * 5;
          } else if (line.trim() === '---') {
            // Horizontal line
            doc.setLineWidth(0.5);
            doc.line(margin, y, pageWidth - margin, y);
            y += 5;
          } else if (line.trim() === '') {
            // Empty line
            y += 4;
          } else {
            // Regular text
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const wrappedText = doc.splitTextToSize(line, maxWidth);
            doc.text(wrappedText, margin, y);
            y += wrappedText.length * 5;
          }
        });
        
        // Save the PDF
        doc.save(filename);
      }
    </script>
  </BaseLayout>
)}

<style>
  /* Login Styles */
  .login-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--surface) 0%, white 100%);
    padding: var(--space-4);
  }

  .login-box {
    background: white;
    padding: var(--space-8);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    max-width: 400px;
    width: 100%;
  }

  .login-box h1 {
    font-size: var(--text-3xl);
    margin-bottom: var(--space-2);
    text-align: center;
  }

  .login-description {
    text-align: center;
    color: var(--text-light);
    margin-bottom: var(--space-4);
  }

  .error-message {
    background-color: #fee;
    border: 1px solid #fcc;
    color: #c33;
    padding: var(--space-3);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-4);
    text-align: center;
  }

  .login-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  /* Login Styles */
  .login-container {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: calc(100vh - var(--header-height, 0px));
    padding: var(--space-4);
    background: var(--surface);
  }

  .login-box {
    background: white;
    padding: var(--space-8);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    width: 100%;
    max-width: 400px;
    text-align: center;
  }

  .login-box h1 {
    font-size: var(--text-3xl);
    margin-bottom: var(--space-2);
    color: var(--secondary);
  }

  .login-description {
    color: var(--text-light);
    margin-bottom: var(--space-6);
  }

  .error-message {
    background: #fef2f2;
    color: var(--error);
    padding: var(--space-3);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-4);
    font-size: var(--text-sm);
    border: 1px solid #fee2e2;
  }

  .login-form {
    text-align: left;
  }

  .login-form .form-group {
    margin-bottom: var(--space-4);
  }

  .login-form .btn {
    width: 100%;
    margin-top: var(--space-2);
  }

  /* Admin Panel Styles */
  .admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--space-6) var(--space-4);
  }

  .admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
    padding-bottom: var(--space-4);
    border-bottom: 2px solid var(--border);
  }

  .admin-header h1 {
    font-size: var(--text-4xl);
    color: var(--primary);
  }

  .admin-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
  }

  .instructions {
    background: var(--surface);
    padding: var(--space-4);
    border-radius: var(--radius-md);
    border-left: 4px solid var(--primary);
  }

  .instructions h2 {
    font-size: var(--text-xl);
    margin-bottom: var(--space-2);
  }

  .instructions p {
    color: var(--text-light);
    line-height: var(--leading-relaxed);
  }

  .generator-form {
    background: white;
    padding: var(--space-6);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
  }

  .form-group {
    margin-bottom: var(--space-4);
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: var(--space-2);
    color: var(--text);
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: var(--space-3);
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    font-size: var(--text-base);
    font-family: inherit;
    transition: border-color var(--transition-fast);
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--primary);
  }

  .form-group textarea {
    resize: vertical;
    font-family: 'Courier New', monospace;
  }

  .form-group small {
    display: block;
    margin-top: var(--space-2);
    color: var(--text-light);
    font-size: var(--text-sm);
  }

  .form-actions {
    display: flex;
    justify-content: center;
    margin-top: var(--space-6);
  }

  .btn-loader {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
  }

  .btn-loader::after {
    content: '';
    width: 16px;
    height: 16px;
    border: 2px solid currentColor;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .results {
    margin-top: var(--space-8);
  }

  .results > h2 {
    font-size: var(--text-3xl);
    margin-bottom: var(--space-6);
    text-align: center;
  }

  .document-section {
    background: white;
    padding: var(--space-6);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    margin-bottom: var(--space-6);
  }

  .document-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-3);
    border-bottom: 2px solid var(--border);
  }

  .document-header h3 {
    font-size: var(--text-2xl);
    color: var(--primary);
  }

  .document-content {
    background: var(--surface);
    padding: var(--space-4);
    border-radius: var(--radius-md);
    max-height: 600px;
    overflow-y: auto;
  }

  .document-content pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: 'Courier New', monospace;
    font-size: var(--text-sm);
    line-height: var(--leading-relaxed);
    margin: 0;
  }

  .btn-success {
    background-color: #10b981 !important;
    border-color: #10b981 !important;
    color: white !important;
  }

  /* LinkedIn Optimizer Specific Styles */
  .linkedin-optimizer {
    border-top: 4px solid var(--accent);
  }

  .admin-skills-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--space-2);
    margin-top: var(--space-4);
  }

  .skill-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--surface);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
    transition: all var(--transition-fast);
  }

  .skill-item:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
  }

  .skill-name {
    font-size: var(--text-sm);
    font-weight: 500;
  }

  .copy-skill-btn {
    background: none;
    border: none;
    color: var(--text-light);
    cursor: pointer;
    padding: 2px;
    display: flex;
    align-items: center;
    transition: color var(--transition-fast);
  }

  .copy-skill-btn:hover {
    color: var(--primary);
  }

  /* Gap Analysis Styles */
  .gap-analysis .document-content {
    color: #991b1b;
  }

  .gap-list ul {
    list-style-type: none;
    padding: 0;
    margin: 0;
  }

  .gap-list li {
    position: relative;
    padding-left: var(--space-6);
    margin-bottom: var(--space-2);
    font-weight: 500;
  }

  .gap-list li::before {
    content: '⚠️';
    position: absolute;
    left: 0;
  }

  .gap-list p {
    font-weight: 600;
    margin-bottom: var(--space-3);
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .admin-header {
      flex-direction: column;
      gap: var(--space-3);
      align-items: flex-start;
    }

    .admin-header h1 {
      font-size: var(--text-2xl);
    }

    .document-header {
      flex-direction: column;
      gap: var(--space-3);
      align-items: flex-start;
    }

    .document-header .btn {
      width: 100%;
    }
  }
</style>